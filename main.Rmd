
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, message = F, warning = F) 
knitr::opts_chunk$set(fig.pos = 'htpb', fig.align = 'center') 
knitr::opts_chunk$set(out.width = '100%', dpi=300) 
knitr::opts_chunk$set(fig.env="figure") 
```

```{r libs, include=FALSE}
library(tidyverse)
library(lubridate)
library(magrittr)
library(readxl)
library(tsibble)
library(slider)
library(xts)
library(timetk)
library(patchwork)
library(rlang)
library(kableExtra)
library(dynlm)
library(broom)
library(lmtest)
library(sandwich)
library(stargazer)
library(latex2exp)
library(bHP)
library(pROC)
```

```{r plot-setup, include=FALSE}
ggplot2::theme_set(theme_minimal() + theme(
  legend.title = element_blank(), 
  legend.position = "bottom"))
```

# Introduction {#intro}



Modern economics concerns with the efficient allocation of real goods and wealth
through the market mechanism. The real "goods" aspects of the economy has been 
the focus of economic analysis.
Yet as long as we are not living in a bartering economy,
Economic living always involve "financial" aspects associated with transaction 
mediation, debt issuance, and asset accumulation. 


Economic views about the role of finance in macroeconomic has involved over time. 
Money view. irrelevant view. credit view. 

The onset of the global financial crisis has rekindled a wave of rethink of 
this matter.

The Global Financial Crisis has prompted a rethink of the role of finance to the
real economy. Though the view that financial factors generate economic
fluctuations has been along for centuries, the mainstream neoclassical thinking
is that "money is a veil" and financial institutions are just intermediaries
which alters no substance in the real economy.

However, the onset of GFC demonstrated the great disruptions that financial
factors could bring about. It is clear that the relationship between the "Wall
Street" and the "Main Street" is not fully captured by just interest rates -- 
as it is commonly assumed in neoclassical literature.

After the GFC, growing efforts have been devoted to bridge the gap between
finance and real economy. On the theoretical side, notably, Gertler and Kiyotaki
(2011). Empirical literature have focused on capturing the regularities of
financial cycles and how it intereacts with real business cycles
(Claessens, 2011).



# Literature review

The idea that financial aspects are nonneutral and could have real impact on the 
economy is nothing new.
Early discussion of the matter dates back to early eighteenth century, when
French economist Richard Cantillon discovered that increasing quantity of money 
does not raise the price level uniformly, but incurs redistribution effect:
those who are close to money creation benefit from an earlier rise in price 
and income. Therefore, they can enjoy a higher standard of living at the expense 
of those far away from money creation. 

However, Cantillon's nonneutral monetary theory was more than overwhelmed by 
the influential classic writers such as Adam Smith, who popularized the profound 
economic thought that "money is a veil".
Smith wrote:

> It would be too ridiculous to go about seriously to prove, that wealth does 
not consist in money, or in gold and silver; but in what money purchases, and 
is valueable only for purchasing...
To attempt to increase the wealth of any country, either by introducing or by 
detaining in it an unnecessary quantity of gold and silver, is as absurd as it 
would be to attempt to increase the good cheer of private families by obliging 
them to keep an unnecessary number of kitchen utensils. [@Smith, p.406]

The idea of "money veil" dominated throughout the Smith-Ricardo tradition.
The precise job of economists is to look through the veil and reveal
the "real" economic relations behind it. 
Smith recognized that banking operations might improve economic performance, but
banking was not regarded as anything essential to the wealth of a nation. 

The nineteenth century development gave birth to the controversy between the 
Currency School, who adhered to the Quantity Theory and believed paper money 
should function as if they were gold, and the Banking School, who noticed 
deposits played an important role in money creation and money supply was
driven by market demand. 
For the purpose of this paper, we naturally give more attention to the Banking
School, since there is no gold or silver in our monetary system any more, and 
modern finance is more close to the picture painted by banking school theorists.

Knut Wicksell's work at the turn of the century advanced the nineteenth century
money and banking theories into the twentieth century.
Wicksell's theory was definitely influenced more by the Banking School, 
particularly Thomas Tooke, than the Currency School. 
Wicksell differentiated a "pure cash economy" from a "credit economy".
In the latter case, "the necessary quantity of money can be infinitely small, 
and its velocity of circulation to be infinitely great" [@Wicksell, p.65].
With organized credit channeling (i.e. banking), money does not even have to
circulate at all to facilitate transactions, since "all domestic payments are
effected by means of the *Giro* system and bookkeeping transfers" 
[@Wicksell, p.70].
In such a system, the supply of money is totally elastic, which makes 
deducting price level from the quantity of money insensible. 
Wicksell therefore diverted the focus of monetary control from reserve 
quantities to the rate of interest, claiming that 
the linkage between financial operations and the real economy is through the 
difference between the money rate of interest and the "natural rate of interest" 
(real return on capital).
Whenever the money rate of interest is lower than the natural rate of interest, 
a surplus is generated as entrepreneur profits, which encourages business 
expansion.
Therefore, excessive credit facilitates overly expansion. 
The inevitable speculative behavior developed during expansion presage 
a future economic downturn as correction.

> Under special conditions simple credit may itself be capable of a significant
degree of expansion, for instance at times of speculation as a result of the
attractiveness of higher profits, or of the offer of ever higher prices or of
a higher rate of interest. But as soon as this incentive disappears, the
contraction is correspondingly catastrophic, as is revealed in the period of
crisis that ensues. Everybody now hastens to fortify his balances, which appear
much too small in relation to the new level of prices. The demand for goods
contracts, their supply increases, and prices fall, for a time possibly far
below their normal levelâ€”particularly if confidence has been strained and
general mistrust prevails. [@Wicksell, p.62]


Joseph Schumpeter's development-oriented and innovation-based banking theory 
has made special contributions to monetary thinking.
Schumpeter regarded "economic development consists in a different employment of 
existing services of labor and land", and banking credit is essential to the 
process of development.

> The essential function of credit in our sense consists in enabling the 
entrepreneur to withdraw the producers' goods which he needs from their 
previous employments, by excercising a demand for them, and thereby to force
the economic system into new chanels... 
the nature of the process, which consists in creating a new demand for, 
without simultaneously creating, a new supply of goods.
[@Schumpeter, p.106]

The peculiar of banking business is precisely, contrary to the common belief, 
that banks do not lend depositors' money, but create purchasing power 
on their own.
Banks identify profitable business and grand them purchasing power so that 
productive resources can be drawn from other employment and reallocated into 
the new business. 
In this regard, banks play a central role of resource allocation in a 
capitalist economy, which is considered by Schumpeter the key difference 
between a capitalist economy and a command or planned economy. 
Money is never a veil in a capitalist setting, "...the essential features 
of the capitalist process may depend upon the 'veil' and that the 'face 
behind it' is incomplete without it."
In Schumpeter's "creative destruction" paradigm, recessions or crisis can be 
viewed as "credit booms gone wrong". 
"This loss always occurs if the entrepreneur does not succeed in producing 
commodities at least equal in value to the credit plus interest."
[@Schumpeter, p.114]


The Great Depression in the early twentieth century sparked various economic
thoughts attempting to explain how financial stress transmitted to economic
crisis. One of the most notable theories among them is Fisher's 
"debt deflation" theory [@Fisher1933].
According to Fisher, when an economy is heavily indebted, debt liquidation 
and deflation triggers a downward spiral that sends the economy to deep crisis.

> Assuming, accordingly, that, at some point of time, a state of over-
indebtedness exists, this will tend to lead to liquidation, through the alarm 
either of debtors or creditors or both. 
Then we may deduce the following chain of consequences in nine links: 
(1) Debt liquidation leads to distress selling and to 
(2) Contraction of deposit currency, as bank loans are paid off, and to a
slowing down of velocity of circulation. This contraction of deposits and of
their velocity, precipitated by distress selling, causes 
(3) A fall in the level of prices, in other words, a swelling of the dollar. 
Assuming, as above stated, that this fall of prices is not interfered with by 
reflation or otherwise, there must be 
(4) A still greater fall in the net worths of business, precipitating
bankruptcies and 
(5) A like fall in profits, which in a "capitalistic," that is, a private-
profit society, leads the concerns which are running at a loss to make 
(6) A reduction in output, in trade and in employment of labor. These
losses, bankruptcies, and unemployment, lead to 
(7) Pessimism and loss of confidence, which in turn lead to 
(8) Hoarding and slowing down still more the velocity of circulation. 
The above eight changes cause 
(9) Complicateddisturbances in the rates of interest, in particular, a fall
in the nominal, or money, rates and a rise in the real, or commodity, rates 
of interest.
[@Fisher1933]

Another influential school of thoughts spawned by the 
Great Depression is Monetarism, largely due to the work of @friedman1963a.
Friedman and Schwartz, through a careful study of the monetary history of the 
United States, found that 

> Changes in money income and prices have, in every case, been accopanied by 
a change in the rate of growth of the money stock, in the same direction and 
of appreciate magnitude, and there are no comparable disturbances in the rate 
of growth of the money stock unaccompanied by changes in money income and prices.
[@friedman1963b]

The quantity of money, therefore, is an independent source of economic 
fluctuations, not merely a reflection of cyclical behavior of the real economy. 

> The reflex influence of business on money...would then become part of the 
partly self-generating mechanism whereby monetary disturbances are transmitted.
[@friedman1963b]

The central mechanism transmitting monetary shocks to economic fluctuations, 
identified by Friedman and Schwartz, is through portfolio adjustments. 
For example, an initial impulse on money stocks disturbs money holders' 
portfolio of money and securities, thus triggers a portfolio rebalance toward
more security holdings.
As they seek to purchase these assets, they will bid up the prices of financial 
assets. As a result, an imbalance of the portfolio with financial wealth and 
real income will emerge, which leads to more purchasing of real goods and 
services, therefore raise the general price level.
Friedman and Schwartz also argue the portfolio adjustment movement always has 
a tendency to overshoot because of adaptive expectations and feedback effects.
The dynamic process of overshooting and adjustment fulfills a 
"monetary theory of partly self-generating cyclical fluctuations".

Although the effect of changing stocks of money on economic activities is 
undeniable, we believe that the monetary theory of business cycle is inadequate.
First of all,
in present times with increasing complexity of financial markets, a whole range
of quasi-money assets are created and compete with traditional banking deposits.
It becomes less justified to exclusively focus on banking deposits which is the 
only financial assets regarded as money.
Money is inadequate in modern context in the sense that money fails to account 
for a hefty amount of intermediary flows.
Empirical studies also identified a decoupling of credit and money in postwar 
period, that money becomes a less credible predictor for business cycles 
[@Schularick2012].
Secondly,
exclusively focusing on money will miss important mechanism that finance 
interacts with the real economy. As pointed out by @Schumpeter and @Fisher1933,
financial forces affect real economic activities not only through the quantity 
of money, but the quality of financing and the level of indebtedness is also 
critical. 
In other words, in terms of financial and economic stability, what matters 
is the overall liability structure, not only the narrowly defined stock of money.
For the above reason, throughout this paper we focus on total credit generated 
by the financial system (including both banks and nonbank institutions), 
not the stock of money. 


@GurleyShaw is a remarkable work on theorizing financial markets and institutions.
Gurley and Shaw realized that narrowly focusing on money was no longer  
appropriate in the context of post-war U.S. 
They "attempt to develop a theory of finance that encompasses the theory of money".
@GurleyShaw developed a general equilibrium framework for financial assets and 
debt. They emphasize how financial development alters the equilibrium growth path 
even without price stickness or money illusion.

> We have played the game according to the ground rules of neo-classical 
economics in order to show that even here money is not a veil, that it may
have an important role to play in determining the level and position of output.
[@GurleyShaw, p.10]

The reason is briefly as following: suppose there are more debt issuance,
given the spending units' portfolio preference, their demand for liquidity 
grows as debt accumulates. If the supply of money stays constant, it will
entail a higher interest rates in the new equilibrium, which will no long 
be the same as the previous one. 
Therefore, to maintain a balanced growth path, monetary policy must expand
proportional to rising debt to satisfy the portfolio diversification demand 
of spending units. 
This is true even in neo-classical settings with perfect price flexibility.

The development of nonmonetary intermediaries alter the equilibrium too.
The presence of money substitutes tend to offset central banks' effort to 
control the money supply, which renders monetary policy less effective. 
Therefore, what matters, to both growth and monetary policy concerns, is the 
"financial capacity", which is the capacity to absorb debt without restrain
the current spending [@gertler1988].
Financial intermediaries are important because they enrich the channels of 
financial resources and make it possible for certain borrowing and lending
that would be infeasible otherwise.


However, before the theories of Gurley and Shaw gained influence, the 
stagflation experience of the 1970s gave rise to the school of rational 
expectations, and culminated in the Real Business Cycle (RBC) theory 
[@prescott1982].
The RBC theory projects business cycles as efficient response to real 
exogenous shocks, and denies any endogenously generated fluctuations. 
The RBC theory is a revival of the classical dichotomy: money becomes 
a veil again.
More comments on the RBC theory is unnecessary. The correctness of the theory
is irrelevant here because RBC provides no explanation for the financial 
aspects of the economy, which is the main concern of this paper.
As @Borio2014 remarked: "since shocks can be regarded as a measure of our
ignorance, rather than of our understanding, this approach leaves much of 
the behaviour of the economy unexplained."

The end of the Bretton Woods system at early 1970s decoupled the Dollar from 
the gold, since then money lost its peg and could expand without limits. 
The new environment brewed a monetary thought called the "credit view" 
as opposed to the "money view" represented by Milton Friedman. 
The controversy more or less resembled the 19th century debate between the 
Banking School and the Currency School.
@mishkin1978 found that household balance sheet was an important transmission
mechanism during the Great Depression causing the decline of aggregate demand.
@bernanke1983 found money was not enough to explain the severity of the Great
Depression; the collapse of the financial system, choking off credit to the 
economy, was an important determinant of the depth of the depression.
@bernanke1986 showed that credit explained a much larger proportion of money-
income correlation than commonly assumed.
These research diverted the money-focus explanation of economic fluctuation 
to credit creation and balance sheet analysis.

Also the development of modeling techniques, and the discovery of information 
asymmetry, enabled economists to incorporate financial factors in economic
models with the same level of rigor as Real Business Cycle models. 
@bernanke1986 showed that with information asymmetry, financial arrangement 
between borrowers and lenders entails an agent cost. 
Only entrepreneurs with net worth above a certain level can borrow. 
Therefore, the capital supply curve depends on entrepreneurs' net worth.
After a productivity shock that raises the entrepreneurs' net worth, 
the expansion persists because higher net worth enables more borrowing and 
capital accumulation which in turn raise the entrepreneurs' net worth even 
higher.
This is called an "accelerator effect".
@kiyotaki1997 also showed collateral requirements in borrowing tend to amplify 
business cycle fluctuations. 
Because borrowers' credit limits are constrained by the price of the collateral 
assets, while the price of these assets are also affected by the credit limits. 
Therefore, there is a self-reinforcing interaction between credit and asset 
prices that generate business cycles endogenously.


The idea of endogenous business cycles generated by the financial system is 
also propounded by schools of thought outside of the mainstream, such as 
Hyman Minsky's "financial stability hypothesis", which was largely ignored
for decades until the Global Financial Crisis reigniting the interest of 
the theory.
Unlike the neo-classical approach of assuming perfect competition, Minsky 
analyzed a capitalist economy with monopolistic power. 
The function of prices is not only to clear the market and allocate resource,
but must also be able to support the debt structure of the economy.

> ...the normal functioning of a modern capitalist economy depends upon capital 
income (and thus investment) reaching and sustaining a level at which capital
assets earn sufficient income to validate past debts. If this situation does
not prevail, the prices of capital assets and debts fall, and such a decline
adversely affects investment demand.[@minsky2008, p.195]

Therefore, the financial arrangement, or the debt structure, is never a simple
veil, but determines relative prices, income, and output. 
The capitalist economy is "a system of borrowing and lending based upon 
margins of safety" [@minsky2008, p.90], which means the margins of cash 
receipts relative to payment commitments on liabilities. 
The higher the ratio of liabilities to cash flow, or the ratio of external 
to internal financing, the narrower the margins of safety.
@minsky2008 proposed that the financial system is inherently unstable. 
Sustained growth does not only induce more investment, but also a change in 
the financing structure, from internal financing to external financing 
("speculative financing" or "Ponzi financing"), which means the erosion of 
margins of safety. 
If such a financing structure is encountered with a negative shock so that
cash income can no longer validate the financing structure, the system breaks
down and heads toward a financial crisis.



# Data and methodology {#data}

```{r, message=FALSE}
data_raw <- 
  read_excel("data/data_raw.xlsx", sheet = 1) %>%
  mutate(date = as_date(date))

# HP filtered cyclical components
data_cyl <- 
  read_csv("data/data_vars.csv") %>%
  mutate(date = yq(date) + months(2)) %>% 
  # multiple by 100 since log difference means 
  # the percent deviation from the trend
  mutate_at(vars(GDP, House, Credit), ~.*100)

# standardize the cycles by standard deviation (mean = 0)
data_cyl_std <- data_cyl %>%
  mutate_at(vars(-date), ~ ./sd(.))

```


## Choice of variables {#indicators}

I choose three indicators to characterize the financial cycles: credit, house
price and credit to GDP ratio. Credit reflects the aggregate claims created by
the financial system, which is a natural choice to represent financial cycles.
Credit is also regarded by some as the single most powerful indicator for
financial crisis [@Schularick2012]. In this paper, I use the Total Credit to
the Non-Financial Sector from the BIS credit statistics. ^[BIS total credit
comprises financing from all sources, including domestic banks, other domestic
financial corporations, non-financial corporations and non-residents. The
financial instruments covered comprise currency and deposits, loans and debt
securities. Debt securities include bonds and short-term papers; equities,
insurance, pension funds are not included. In Chinese literature, the Aggregate
Financing to the Real Economy (AFRE) indicator is more widely used. However, the
AFRE statistics are only available yearly after 2002, and monthly after 2014.
The coverage of BIS total credit and AFRE largely overlapped. The correlation
between BIS total credit and AFRE after 2014 is 0.9944. To preserve consistency
in data, BIS total credit is used throughout in this paper.] To measure how
much credit is "over-expanded" relative to the size of the economy, credit to
GDP ratio is calculated and included as a separate indicator.

House price is another important indicator of financial cycles. House
properties, though being real estate, have many similar characteristics as
financial assets. As the most commonly accepted collateral for credit, house
prices capture the endogenous relationship between entities' net worth,
borrowing constraints, and credit creation. Strong evidence suggests household
leverage (mainly through mortgage loans) influences business cycles through
credit supply channels [@Mian2017]. In this paper, I use the Average Price of
Commercial Residential Buildings from the National Bureau of Statistics as a
measure of house prices. ^[This only includes a portion of the total
residential properties in China, indemnificatory housing and other types of
public-built private-owned housing are not included in this statistics. But
narrowing down to privately traded residential properties is a better choice to
reflect market conditions. In Chinese literature, other indicators, such as
average house price of 70 major cities, are more widely used. However, these
indicators are only available for recent years. The indicator chosen in this
paper traced the house prices back to 1998, the beginning of China's housing
reform. ]

The data are at quarterly frequency, ranging from 1999 to 2019. The data starts
from 1999, firstly due to the data availability; secondly, considering China
took a major reform in the housing market in July 1998 -- since then residential
properties can be freely traded in the market -- the house prices before 1999
have little value for the purpose of this paper. The time series are seasonally
adjusted whenever necessary. ^[Except for GDP, I do not adjust the data for
inflation. For the purpose of studying financial cycles, it is the nominal
values that matter. ]


```{r plot-raw-data, include=F}
# fig.heighht = 3.5
data_raw %>%
  filter(year(date) > 1998) %>%
  pivot_longer(2:7) %>%
  group_by(name) %>%
  ggplot(aes(x = date, y = value)) +
  facet_wrap(~name, scales = "free_y") +
  labs(x = NULL, y = NULL) +
  geom_line() 

data_cyl %>%
  pivot_longer(2:7) %>%
  group_by(name) %>%
  ggplot(aes(x = date, y = value)) +
  facet_wrap(~name, scales = "free_y") +
  labs(x = NULL, y = NULL) +
  geom_line() 
```


## Cycle extraction {#cycle}

There are many methodologies to identify cycles in macroeconomic variables. The
classical method tracks absolute increase or decrease of economic activities.
For example, a recession is identified by two consecutive quarters of declines
of GDP. However, this "classical" business cycle definition is not suitable for
fast-growing economies, in which macroeconomic variables are constantly in
upward movement. For fast-growing economies, the "growth cycle methodology" is
more appropriate, which identifies cycles as fluctuations around a trend. In
this paper, I apply the Hodrick-Prescott (HP) filter to extract the cyclical
components from the time series. ^[The lambda value is set to 1600 for
quarterly data as suggested by @Hodrick1997. There are other methods used for
cycle extraction in the literature. For example, @Mayong2016 applied HP filter
to YoY changes of variables. This method is problematic, because HP filter is
designed to obtain trends by smoothing out short-term fluctuations. Performing
year-to-year difference by default removes the trend. Another popular approach
is to apply Bank-Pass filters such as Christiano-Fitzgerald (CF) filter. This is
the approach adopted by @Drehmann2012 and @Taihui2018. However, CF filter
pre-imposes the length of the cycle to be within a certain band. According to
@Drehmann2012, the short-term cycles are between 1 and 8 years, and mid-term
cycles are between 8 to 30 years. Since China's data is available for merely 20
years, applying the CF filter is unnecessary and bears the risk of losing too
much information. ] Log-transformation is applied to variables that grow
proportionately to their sizes such as GDP, credit and house prices. The
magnitude of the cycles are standardized by their standard deviation.


@Harding2002's (medium-term) turning-point algorithm is then applied to identify
peaks and troughs of the cycles. Specifically, the algorithm involves two steps:
(1) identifying local maxima and minima over a window of 9 quarters; (2)
imposing censoring rules that the minimum length of each phase of upturn or
downturn is 2 quarters; Further, I impose a third restriction: (3) peaks and
troughs must appear alternately, that is there must be one and only one peaks
(troughs) between two troughs (peaks). Figure \ref{fig:cycle-tp} plots the HP
filtered cycles of the variables together with the identified turning points.

```{r}
# Identify turning point using Harding and Pagan algorithm
# The medium-term window has 9 quarters
#  - Y_t is the peak if it is the maximum within the window
#  - Y_t is the trough if it is the minimum within the window
data_peak_trough <- data_cyl %>%
  pivot_longer(2:7, names_to = "indicator", values_to = "value") %>%
  group_by(indicator) %>%
  mutate(peak = slide_dbl(
    value,  
    function(x) {
      mid <- (length(x) + 1) / 2
      if (which.max(x) == mid) x[mid]
      else NA
    },
    .before = 4, .after = 4, .complete = T)
  ) %>%
  mutate(trough = slide_dbl(
    value,  
    function(x) {
      mid <- (length(x) + 1) / 2
      if (which.min(x) == mid) x[mid]
      else NA
    },
    .before = 4, .after = 4, .complete = T)
  ) %>%
  arrange(.by_group = T)
```

```{r}
# this function is used to count the number of cycles
count_nonNA <- (function() {
  # counter inside closure
  .counter <- 0L 
  # for each group, reset the counter
  .group <- 'default'
  # return this function
  function(value, group = 'default') {
    if (group != .group) {
      .group <<- group
      .counter <<- 0L
    }
    if (!is.na(value)) {
      .counter <<- .counter + 1L
    }
    return(.counter)
  }
})()

# compute peak/trough cycles: periods between two peaks (or troughs)
# each non-NA value in `peak` or `trough` indicates 
# the start or end of a cycle
data_peak_trough %<>%
  group_by(indicator) %>%
  mutate(peak_cycle= map2_int(peak, indicator, count_nonNA)) %>%
  mutate(trough_cycle = map2_int(trough, indicator, count_nonNA)) 
```

```{r}
# We restrict peaks and troughs must appear alternately, i.e. 
# - between two peaks, there is only one trough
# - between two troughs, there is only one peak
data_peak_trough %<>%
  group_by(indicator, peak_cycle) %>% 
  mutate(trough = (function(x) {
      if (all(is.na(x))) x
      else {
        # if there are non-minimal values within two peaks
        # assign those values to NA
        min_x <- min(x, na.rm = T)
        x %>% map_dbl(~ if_else(. > min_x, NA_real_, .))
      }
    })(trough)
  )  

data_peak_trough %<>%
  group_by(indicator, trough_cycle) %>% 
  mutate(peak = (function(x) {
      if (all(is.na(x))) x
      else {
        # if there are non-maximal values within two troughs
        # assign those values to NA
        max_x <- max(x, na.rm = T)
        x %>% map_dbl(~ if_else(. < max_x, NA_real_, .))
      }
    })(peak)
  ) 

# after correcting turning points, recompute peak/trough cycles
data_peak_trough %<>%
  group_by(indicator) %>%
  mutate(peak_cycle = map2_int(peak, indicator, count_nonNA)) %>%
  mutate(trough_cycle = map2_int(trough, indicator, count_nonNA)) 
```

```{r}
# this is a trick that generates -1, 1, -1, 1,... sequence
ss_substract <- function(x, y) {
  z <- x - y
  if (sum(z) > 0) 
    z[z==0L] <- -1L
  else if (sum(z) < 0) 
    z[z==0L] <- 1L
  z
}

# merge peaks and troughs together
# each peak-to-trough or trough-to-peak is counted 
data_peak_trough %<>%
  group_by(indicator) %>%
  mutate(peak_trough = if_else(!is.na(peak), peak, trough)) %>%
  # 1 means a upturn phase; -1 means a downturn phase
  mutate(up_down = ss_substract(trough_cycle, peak_cycle)) %>%
  mutate(peak_trough_cycle = (peak_cycle + trough_cycle) * up_down)
```

```{r cycle-tp, fig.cap="Business cycles and turning points"}
# plotting the cycles together with the turning points
data_peak_trough %>%
  ggplot(aes(x=date)) +
  geom_line(aes(y=value)) +
  geom_point(aes(y=peak), shape=24, fill="blue") +
  geom_point(aes(y=trough), shape=21, fill="red") +
  facet_wrap(~indicator, scales = "free_y") + 
  labs(x=NULL, y=NULL) 
```


# Basic features of financial cycles in China {#features}

## Duration and amplitude {#duration}


```{r}
# calculate the duration (number of quarters) of 
# each contraction or expansion cycle
stat_duration <- data_peak_trough %>% 
  group_by(indicator, peak_trough_cycle) %>%
  summarise(n = n()) %>%
  mutate(phase = case_when(
    peak_trough_cycle > 0 ~ "Upturn", 
    peak_trough_cycle < 0 ~ "Downturn"
  )) %>% 
  filter(!is.na(phase)) %>%
  group_by(indicator, phase) %>%
  summarise(duration = mean(n)) 
```

```{r}
# calculate the amplitude of each cycle
# we use non-standardized cyclical series to reflect true order of magnitude
stat_amplitude <- data_cyl %>% 
  pivot_longer(2:7, names_to = "indicator",values_to = "value") %>%
  left_join(
    data_peak_trough %>% select(date, indicator, peak_trough, peak_trough_cycle), 
    by = c("date", "indicator")
  ) %>% 
  group_by(indicator) %>%
  arrange(.by_group = TRUE) %>%
  # creating a leading vector, the number represents the peak or trough \
  # in a upturn or downturn phase
  mutate(peak_trough_1 = dplyr::lead(peak_trough, order_by = date)) %>%
  group_by(indicator, peak_trough_cycle) %>%
  summarize(
    # the amplitude means the maximal percentage deviation from the trend
    # since the trend is log transformed 
    amplitude = sum(peak_trough_1, na.rm=T)
  ) %>%
  mutate(phase = case_when(
    peak_trough_cycle > 0 ~ "Upturn", 
    peak_trough_cycle < 0 ~ "Downturn"
  )) %>% 
  filter(peak_trough_cycle != 0, amplitude != 0) %>%
  group_by(indicator, phase) %>%
  summarise(amplitude = mean(amplitude)) 
```

```{r dur-amp}
# reshape the table for printing
bind_rows(
  # duration table
  stat_duration %>%
    pivot_wider(names_from = phase, values_from = duration) %>%
    mutate(Variable = "Duration (Q)"),
  # amplitude table
  stat_amplitude %>%
    pivot_wider(names_from = phase, values_from = amplitude) %>%
    mutate(
      Variable = if_else(
        indicator %in% c("GDP", "Credit", "House"), 
        "Amplitude (%)", 
        "Amplitude (pp.)"
      )
    )
  ) %>%
  group_by(indicator) %>%
  arrange(.by_group = T) %>%
  mutate(`Full Cycle` = if_else(
    Variable == "Duration (Q)", 
    Upturn + Downturn, 
    NA_real_)
  ) %>%
  select(Indicator = indicator, Variable, everything()) -> stat_dur_amp

options(knitr.kable.NA = '')
kbl(stat_dur_amp, digits = 2, booktabs = T,
    caption = "Basic cyclical features of main variables") %>%
  collapse_rows(columns = 1) %>%
  kable_styling(full_width = F)
```

Based on the identified turning points in Section \ref{cycle}, 
I calculated the duration and amplitude of the cycles for each series (Table
\ref{tab:dur-amp}). The duration of an upturn (downturn) is defined as the
quarters from a trough (peak) to a peak (trough). The amplitude of an upturn
(downturn) is defined as the largest positive (negative) deviation from the
trend.

Table \ref{tab:dur-amp} shows (1) Most variables have full cycles of 10-13
quarters, while GDP and Credit/GDP demonstrate considerable longer cycles that
lasts 18-19 quarters. ^[Spectrum analysis suggests GDP series has a 22-quarter
cycle, CPI a 15-quarter cycle, property price a 22-quarter cycle and
a 12-quarter cycle, credit a 18-quarter cycle and a 12-quarter cycle.] (2) Most
variables exhibit longer quarters of downturn than upturn. An upturn takes an
average of 5-8 quarters, while a downturn generally takes 6-11 quarters. (3) For
GDP and credit, the downturns are more severe than the upturns (more pronounced
amplitude). While for houses, price levels, and interest rates, the amplitude of
troughs are relatively mild compared to peaks. ^[The numbers here demonstrate
drastically different characteristics from financial or business cycles
concluded from developed economies [@Claessens2012; @Borio2014]. In the later
case, financial variables generally have longer cycles than real variables, and
upturns are typically more pronounced in magnitude than downturns. The
difference is partly due to the different methodology adopted in this paper. The
"growth cycle method" is more sensitive to downturns than the "classical
method". Institutional factors also affect the behavior of macroeconomic
variables. For example, strong counter-cyclical fiscal policy is usually adopted
in China during downturns. These factors make real GDP more stable than
financial variables. The results here are consistent with conclusions from
Chinese literature [@Yinan2016; @Taihui2018]. ]

```{r spectrum-analysis, include=FALSE}
gg_spec <- function(x, log=FALSE) {
  sp <- spectrum(x, plot=FALSE)
  tb <- tibble(freq = sp$freq, spec = sp$spec) %>%
    mutate(period = 1/freq)
  tb
}
# gg_spec(data_raw$R007)
# ggplot(.Last.value, aes(x=freq, y=spec)) + geom_line()
```


## Correlation and concordance {#correlation}

Figure \ref{fig:corr} shows the correlation between the series. GDP and CPI
have a strong positive correlation, and both of them are positively correlated
with the interest rate. Credit is negatively correlated with the interest rate,
and hence negatively correlated with GDP and CPI. House prices do not exhibit
strong correlations with any other series.

```{r corr, fig.cap="Correlation between series", message=FALSE}
data_cyl_std %>% GGally::ggpairs(columns = 2:7)
```

To further shed some light on the concordance of the cycles of different series,
I calculated the concordance score between the variables as did by
@Drehmann2012. Concordance measures the percentage of time for which two series
are in the same phase (upturn or downturn). Specifically, the concordance scroe
is defined as

$$ \rho_{XY} = \frac{1}{T} \sum_{t=1}^{T} [\rho_t^{X}\rho_t^{Y} + (1-\rho_t^{X})(1-\rho_t^{Y})]$$

where $\rho_t^{X} = \begin{cases}0, \text{if X is in downturn} \\1, \text{if X is in upturn} \end{cases}$,
$\rho_t^{Y} = \begin{cases}0, \text{if Y is in downturn} \\1, \text{if Y is in upturn} \end{cases}$.


```{r}
# impute value 1 or 0 to upturn or downturn phases
stat_updown <- data_peak_trough %>%
  group_by(indicator, peak_trough_cycle) %>%
  # 1 indicate an upturn, 0 indicate a downturn
  mutate(is_upturn = if_else(up_down > 0, 1, 0)) %>%
  ungroup() %>%
  select(date, indicator, is_upturn) %>%
  pivot_wider(names_from = indicator, values_from = is_upturn) 
```

```{r cord, warning=FALSE}
stat_updown %>%
  select(-date) %>%
  map(function(each, others) {
    map_dbl(others, ~ sum(.x*.y + (1-.x)*(1-.y), na.rm = T)/length(.x), each)
  }, stat_updown %>% select(-date)) %>%
  as_tibble(rownames = NA) -> stat_concord
rownames(stat_concord) <- names(stat_concord)

stat_concord %>% 
  rownames_to_column(var = "Variables") %>%
  kbl(digits = 2, booktabs = T, caption = "Concordance between variables") %>%
  kable_styling(full_width = F)
```


The concordance scores (Table \ref{tab:cord}) shows that GDP and CPI have 68%
of their cycles overlapped. Interest rate cycles overlap 67% of GDP cycles, 64%
of credit cycles, and 62% of house price cycles. Credit cycles have relatively
low concordance with real variables, 55% with GDP, and 39% with CPI. House
prices have almost half of the cycles overlapped with all other variables,
though the concordance with interest rate is slightly higher up to 62%.


## Event study around financial cycle peaks and troughs {#event}

It is of particular interest how macroeconomic variables behave after 
a financial cycle indicator peaks or troughs. 
This section conducts an event study based on the peaks and troughs 
identified in Section \ref{cycle}.

Figure \ref{fig:event-study-2} traces the average real GDP gaps 
after a peak or trough in each of the three financial cycle indicators. 
For comparison, Figure \ref{fig:event-study-2} also shows a reference trend 
after a "placebo" event (the average of 1000 random draws of 6 consecutive 
quarters from the dataset). 
In every scenario, the dynamics of real GDP is visibly different from the 
"placebo" reference. 

Several observations are worth to remark. 
(1) Real GDP on average peaks in 4 quarters after a credit cycle peaks, 
and falls below the trend in 6 quarters; 
while after a credit cycle troughs, real GDP troughs in 2 quarters, 
and moves above the trend in 5 quarters. 
(2) The real economy responds more promptly to real estate cycles. 
Real GDP peaks in just 2 quarters after real estate price peaks, 
and troughs almost simultaneously as real estate price troughs. 
(3) Real GDP has a sluggish response to overall leverage cycles. 
Real GDP peaks in 4-6 quarters after a leverage cycle peaks, and bottoms 
in 2-4 quarters after a leverage cycle troughs; 
however, the real GDP never reverses to the other side of the growth trend 
after it peaks or troughs, which signals a less consequential response 
of the real economy. 


```{r data-preparation}
# preparing leads and lags data for event study
data_leads_lags <- ungroup(data_peak_trough) %>% 
  mutate(name = case_when(
    indicator == "Credit/GDP" ~ "Leverage", 
    indicator == "R007" ~ "IR", 
    TRUE ~ indicator)) %>% 
  mutate(peak = if_else(is.na(peak), 0L, 1L)) %>% 
  mutate(trough = if_else(is.na(trough), 0L, 1L)) %>% 
  select(date, name, value, peak, trough) 
# generate leads and lags
# todo: is there a way to automate this?
data_leads_lags %<>%  # assign back to tibble
  group_by(name) %>% 
  mutate(
    L0 = dplyr::lag(value, 0L),
    L1 = dplyr::lag(value, 1L), 
    L2 = dplyr::lag(value, 2L),
    L3 = dplyr::lag(value, 3L),
    L4 = dplyr::lag(value, 4L),
    L5 = dplyr::lag(value, 5L),
    L6 = dplyr::lag(value, 6L),
    H0 = dplyr::lead(value, 0L), # duplicated values L0
    H1 = dplyr::lead(value, 1L),
    H2 = dplyr::lead(value, 2L),
    H3 = dplyr::lead(value, 3L),
    H4 = dplyr::lead(value, 4L),
    H5 = dplyr::lead(value, 5L),
    H6 = dplyr::lead(value, 6L)
  ) %>% 
  select(!value) %>% 
  pivot_wider(values_from = c(L0:L6, H0:H6, peak, trough))
```

```{r event-study-helpers}
# calculate summary statistics around a time event
# condition: condition for the event (in expression)
# var_names: vector of variable names to summarize
summarize_around_event <- function(data, condition, var_names) {
  # convert H1, L1, ... to 1, -1, ...
  lags_as_integer <- function(name) {
    if_else(str_starts(name, "L"), 
            gsub("L", "-", name), 
            gsub("H", "", name)
            ) %>% as.integer
    }
  # returns a dataframe with columns:
  # - index: leads and lags around the event
  # - columns: mean of variables of interest
  data %>% 
    filter({{ condition }}) %>% 
    select(contains(var_names)) %>% 
    select(!contains(c("peak", "trough"))) %>% 
    pivot_longer(everything()) %>% 
    separate(name, c("index", "name"), remove = T) %>% 
    mutate(index = lags_as_integer(index)) %>% 
    group_by(name, index) %>% 
    # todo: is it okay to remove NAs?
    summarise(value = mean(value, na.rm = T)) %>%  
    pivot_wider() 
}

# generate 'placebo' event (no event actually happened) used for reference
# e.g. randomly draw a sample of 13 consecutive quarters for 1000 times
#      and calculate the mean. 
placebo_event <- function(data, var_names, random_draws = 1000) {
  data %>% 
    sample_n(random_draws, replace = T) %>% 
    summarize_around_event(., TRUE, var_names) %>% 
    rename_with(~str_c(., " placebo"), !index)
}

# plot the mean of the variables of interest around the event
# event_df: must be the returned dataframe from summarize_around_event
# x_lab: label for x-axis
# y_max: max value of y-axis
# var_names: not applicable at the moment
plot_event <- function(event_df, x_lab = NULL, y_max = 2) {
  
    event_df %>% 
    filter(index >=0 ) %>% 
    pivot_longer(!index) %>% 
    ggplot(aes(index, value, col=name, linetype=name)) + 
    geom_line() +
    geom_vline(xintercept = 0, col ="grey") +
    geom_hline(yintercept = 0, col = "grey") + 
    scale_y_continuous(limits = c(-y_max, y_max)) +
    labs(x = x_lab, y = NULL) +
    theme(aspect.ratio = 0.8)
}

```

```{r event-study-1, include=F, eval=F, fig.cap="Dynamics around peaks and troughs", fig.asp = 1.2}
(data_leads_lags %>% 
  summarize_around_event(., peak_Credit == 1L, c("GDP", "CPI")) %>% 
  plot_event(., "Quarters after credit peak",1)  
) +
(data_leads_lags %>% 
  summarize_around_event(., trough_Credit == 1L, c("GDP", "CPI")) %>% 
  plot_event(., "Quarters after credit trough",1)  
) +
(data_leads_lags %>% 
  summarize_around_event(., peak_House == 1L, c("GDP", "CPI")) %>% 
  plot_event(., "Quarters after real estate peak", 1)
)  +
(data_leads_lags %>% 
  summarize_around_event(., trough_House == 1L, c("GDP", "CPI")) %>% 
  plot_event(., "Quarters after real estate trough", 1)
) +   
(data_leads_lags %>% 
  summarize_around_event(., peak_Leverage == 1L, c("GDP", "CPI")) %>% 
  plot_event(., "Quarters after leverage cycle peak", 2)
)  +
(data_leads_lags %>% 
  summarize_around_event(., trough_Leverage == 1L, c("GDP", "CPI")) %>% 
  plot_event(., "Quarters after leverage cycle trough", 2)
) + 
plot_layout(ncol = 2, guides = "collect")
```

```{r event-study-2, fig.cap="Real GDP after financial cycle peaks and troughs", fig.asp = 1.2}
(summarize_around_event(data_leads_lags, peak_Credit == 1L, "GDP") %>% 
  left_join(placebo_event(data_leads_lags, "GDP"), by = "index") %>% 
  plot_event(., "Quarters after credit peak", 1)
) +
(summarize_around_event(data_leads_lags, trough_Credit == 1L, "GDP") %>% 
  left_join(placebo_event(data_leads_lags, "GDP"), by = "index") %>% 
  plot_event(., "Quarters after credit trough", 1)
) +
(summarize_around_event(data_leads_lags, peak_House == 1L, "GDP") %>% 
  left_join(placebo_event(data_leads_lags, "GDP"), by = "index") %>% 
  plot_event(., "Quarters after real estate peak", 1)
) +
(summarize_around_event(data_leads_lags, trough_House == 1L, "GDP") %>% 
  left_join(placebo_event(data_leads_lags, "GDP"), by = "index") %>% 
  plot_event(., "Quarters after real estate trough", 1)
) +
(summarize_around_event(data_leads_lags, peak_Leverage == 1L, "GDP") %>% 
  left_join(placebo_event(data_leads_lags, "GDP"), by = "index") %>% 
  plot_event(., "Quarters after leverage cycle peak", 2)
) +
(summarize_around_event(data_leads_lags, trough_Leverage == 1L, "GDP") %>% 
  left_join(placebo_event(data_leads_lags, "GDP"), by = "index") %>% 
  plot_event(., "Quarters after leverage cycle trough", 2)
) +
plot_layout(ncol = 2, guides = "collect")
```


# Financial cycles and business cycles {#regress}

## Aftermath of financial cycle peaks and troughs

To examine the predictability of financial cycle peaks and troughs for 
subsequent real GDP more formally, this section estimates a local projection 
following @jorda2005, which allows including controls flexibly.
I estimate the following specification for horizons $h=1,\dots,6$:

\begin{equation}
\label{eq:lp-peak}
y_{t+h} = \mu_h + \delta_h^{(P)} \text{PEAK}_t + \Phi(L)X_t +\epsilon_{t+h}, 
\end{equation}

\noindent 
where $\text{PEAK}_t$ is a dummy variable which equal to $1$ when time $t$ is 
the peak of a particular time series, specifically, one of credit, real estate 
price, and leverage ratio. 
$y_{t+h}$ is the real output gap $h$ periods ahead of $t$. 

Equation (\ref{eq:lp-peak}) also controls for several macroeconomic variables,
captured in $X_t$, including lagged real output, inflation, interest rates,
as well as lagged credit, real estate price and leverage ratios.
I include three period lags in all estimations, though the results are 
not sensitive to the length of lags. 

The parameter of interest is $\delta_h^{(P)}$, which captures the response of 
subsequent real GDP gaps after financial cycle peaks. 
Note that the linkage between financial cycles and real business cycles could 
come from two sources. First, it is possible that a contraction of financial 
cycles starves financing resources from the real economy, and thus cause a 
downturn in real business cycle. 
Second, it is also possible that financial agents anticipate a real economy 
downturn in the future and withdraw financial resources beforehand, thus 
financial indicators, both credit and asset prices, usually exhibit 
forward-looking characters.  

Therefore, the estimation in this section does not have a causal interpretation, 
but provides an average predicted path of subsequent real output gaps following 
a peak or trough of financial cycle.
Given specification (\ref{eq:lp-peak}), the average path of real GDP gap after 
a peak of financial cycle is captured by $\mu_h + \delta_h^{(P)}$;
while $\delta_h^{(P)}$ spells the difference between the path after financial
cycle peaks and the average path in general cases. 

\begin{equation}
\label{eq:lp-trough}
y_{t+h} = \mu_h + \delta_h^{(T)} \text{TROUGH}_t + \Phi(L)X_t +\epsilon_{t+h}. 
\end{equation}

Similarly, equation (\ref{eq:lp-trough}) is estimated for troughs. 
The average path of real GDP gaps following financial cycle troughs is  
captured by $\mu_h + \delta_h^{(T)}$.

Figure \ref{fig:lp-coef} reproduces the event study with the coefficients 
estimated from Equation (\ref{eq:lp-peak}) and (\ref{eq:lp-trough}). 
The solid lines depict the average paths after financial peaks or troughs 
($\mu_h + \delta_h$); and the dashed lines are the average paths without 
financial cycle disruptions ($\mu_h$). 
Table \ref{tab:lp-table} presents the tabular version of the regression results. 
Standard errors are in Newey-West.
^[Equation (\ref{eq:lp-peak}) and (\ref{eq:lp-trough}) include lags of dependent 
variables. As suggested by @olea2020, it is sufficient to use heteroskedasticity
consistent standard errors in lag-augmented local projections. This paper still 
use heteroskedasticity and autocorrelation consistent standard errors as most
local projection literatures do. ] 

The average paths in Figure \ref{fig:lp-coef} do exhibit different characteristics 
after controls from the unconditional mean in Figure \ref{fig:event-study-2}.
First, real GDP falls below the growth trend shortly after (in one quarter) 
peaks in any of the three financial cycle measures.
Real GDP suffers a severe recessionary gap 6 quarters after credit cycle peaks.
The coefficient of $h=6$ reported in Table \ref{tab:lp-table} shows highly
significance. This suggest contractionary movements of credit presage strong 
contraction in real business cycles.
Peaks of real estate cycles also signal slowdown of real output growth, but 
the effect is not as strong as credit cycles. 

Second, soon after credit or real estate price troughs and begins to expand, 
real GDP moves above the trend and the expansionary gap remains thereafter. 
The coefficients of both credit and real estate cycles for $h=2,\dots,5$ are
highly significant. 
This evidence shows that real business cycle is more responsive to financial 
expansion than contraction, which is not surprising for fast-growing economies
like China. 

Third, the effects of leverage cycles are the weakest among the three. 
The dynamics after leverage ratio peaks or troughs shows ambiguity. 
After the peaks, real GDP moves below the trend for a short period of time, 
and back above the trend in just 3 quarters. 
After the troughs, real GDP remains below the trend for 3 quarters before 
starting to recover. 
These evidence provides little support to the argument that leverage ratio 
is the key to economic stability -- if the expansion of credit or asset prices 
are not accompanied by rising leverage ratio, that is real output grows 
proportionally, it would not pose a thread to economic stability. 
On the contrary, the findings here suggest the dynamics of credit and real 
estate prices presage the dynamics of real output, even if leverage ratios 
are controlled. On the other hand, leverage ratio itself has the weakest 
predictability for subsequent real output levels. 


```{r regression-helpers}
# Run a batch of regressions and return a list of lm results
# formulas: a vector of string formulas to run
# data: the data frame passed on to lm
batch_run_regress <- function(formulas, data) {
  formulas %>% map(~ lm(., data))
}

# Extract the coefficient of a certain regressor from a batch of regressions
# lmfits: a list of lm result
# coef: the variable of interest in the regressors
batch_extract_coef <- function(lmfits, coef) {
  coef <- enquo(coef)
  lmfits %>% imap_dfr(function(fit, i) {
    tidy(fit) %>% 
      filter(term == quo_name(coef)) %>% 
      mutate(index = i - 1) %>% # starts from 0 
      select(index, estimate) %>% 
      rename(!!coef := estimate) 
  })
}

# summarize a batch of lm results into a single table
# coef: a list of coefficients to keep in the output table
#       e.g. list('Print-friendly name' = 'Original name') 
# add_rows: a list of additional rows to add to the output table
#           e.g. list(Controls = "Yes")
# vcov: variance-covariance matrix; if null, robust SE is computed
batch_summarize <- function(lmfits, coefs, add_rows = NULL, vcov = NULL) {
  lmfits %>% imap(function(fit, index) {
    label <- as.symbol(sprintf("(%d)", index))
    tidy(coeftest(fit, NeweyWest)) %>% 
      filter(term %in% names(coefs)) %>% 
      mutate(term = as.character(coefs[term])) %>% 
      mutate(!!label := sprintf("%.3f (%.3f)", estimate, p.value)) %>%  
      select(term, !!label) %>% 
      add_row(term = names(add_rows), !!label := as.character(add_rows)) %>% 
      add_row(term = "$R^2$", !!label := glance(fit) %>% pull(r.squared) %>% format(digits=3)) 
      # add_row(term = "N", !!label := glance(fit) %>% pull(nobs) %>% format()) 
  }) %>% reduce(~full_join(.x,.y, by='term'))
}

# helpers to create formula strings with lags
# I: converts a single symbol to string
# L: creates lagged variables
# H: creates leaded variables
I <- function(x) paste(quo_name(enquo(x)))
L <- function(x, n) paste(sprintf("L%d_%s", n, quo_name(enquo(x))), collapse = "+")
H <- function(x, n) paste(sprintf("H%d_%s", n, quo_name(enquo(x))), collapse = NULL)
# creates regression equation (in string)
# note this returns a vector of strings when lhs is a vector
EQ <- function(lhs, rhs) sprintf("%s ~ %s", lhs, str_c(rhs, collapse = "+"))
```

```{r run-local-projection}
# controls <- c(L(GDP, 1:2), L(CPI, 0:2), L(IR, 0:2))
# todo: should we include a full list of controls?
controls <- c(L(GDP, 1:2), L(CPI, 0:2), L(IR, 0:2),
              L(Credit, 0:2), L(House, 0:2), L(Leverage, 0:2))

lmfit_credit_peak <- 
  EQ(lhs = H(GDP, 0:6), rhs = c(I(peak_Credit), controls)) %>% 
  batch_run_regress(formulas = ., data = data_leads_lags)

lmfit_credit_trough <- 
  EQ(lhs = H(GDP, 0:6), rhs = c(I(trough_Credit), controls)) %>% 
  batch_run_regress(formula = ., data = data_leads_lags)

lmfit_house_peak <- 
  EQ(lhs = H(GDP, 0:6), rhs = c(I(peak_House), controls)) %>% 
  batch_run_regress(formulas = ., data = data_leads_lags)

lmfit_house_trough <- 
  EQ(lhs = H(GDP, 0:6), rhs = c(I(trough_House), controls)) %>% 
  batch_run_regress(formulas = ., data = data_leads_lags)

lmfit_leverage_peak <- 
  EQ(lhs = H(GDP, 0:6), rhs = c(I(peak_Leverage), controls)) %>% 
  batch_run_regress(formulas = ., data = data_leads_lags)

lmfit_leverage_trough <- 
  EQ(lhs = H(GDP, 0:6), rhs = c(I(trough_Leverage), controls)) %>% 
  batch_run_regress(formulas = ., data = data_leads_lags)
```

```{r lp-coef, fig.cap="Real GDP gaps after financial cycle peaks and troughs, with controls", fig.asp=1.2}
# a helper function to plot the coefficients from regression
# lmfit: the lm result
# coef: the symbol of regressor whose coeffient is of interest
# x_lab: label for x-axis
# y_max: max value for y-axis
plot_lp_coef <- function(lmfit, coef, x_lab = NULL, y_max = 2) {
  full_join(
    batch_extract_coef(lmfit, {{ coef }}), 
    batch_extract_coef(lmfit, `(Intercept)`), 
    by = "index"
    ) %>% 
    mutate(treated = {{ coef }} + `(Intercept)`) %>% 
    select(index, treated, untreated =  `(Intercept)`) %>% 
    pivot_longer(!index) %>% 
    ggplot(aes(index, value, col=name, linetype=name)) + 
    geom_line() + 
    geom_vline(xintercept = 0, col ="grey") +
    geom_hline(yintercept = 0, col = "grey") + 
    scale_y_continuous(limits = c(-y_max, y_max)) +
    scale_color_discrete(guide = "none") +
    scale_linetype_discrete(labels = unname(TeX(c("$\\delta_h+\\mu_h", "$\\mu_h")))) +
    labs(x = x_lab, y = NULL) +
    theme(aspect.ratio = 0.8)
}
# patch all six graphs together
plot_lp_coef(lmfit_credit_peak, peak_Credit, "Quarters after credit peak") + 
plot_lp_coef(lmfit_credit_trough, trough_Credit, "Quarters after credit trough") +
plot_lp_coef(lmfit_house_peak, peak_House, "Quarters after real estate peak") +
plot_lp_coef(lmfit_house_trough, trough_House, "Quarters after real estate trough") +
plot_lp_coef(lmfit_leverage_peak, peak_Leverage, "Quarters after leverage cycle peak") +
plot_lp_coef(lmfit_leverage_trough, trough_Leverage, "Quarters after leverage cycle trough") +
plot_layout(ncol = 2, guides = "collect")
```

```{r stargazer, include=FALSE}
# # stargazer is a great package, but I don't use it this time
# do.call(stargazer, args = c(
#   lmfit_credit_peak,
#   lmfit_credit_trough,
#   list(
#     #type = "text",
#     type = "latex",
#     label = "tab-credit-peak",
#     title = "Local projection",
#     keep = c("Constant", "Credit"),
#     dep.var.caption = "",
#     #dep.var.labels.include = F,
#     dep.var.labels = c(str_c("h=", 1:6), str_c("h=", 1:6)),
#     covariate.labels = c("PEAK", "TROUGH", rep(NA, 10)),
#     omit.stat = c("adj.rsq", "ser", "f")
#   )
# ))
```


```{r lp-table}
tbl_credit <- 
  c(lmfit_credit_peak, lmfit_credit_trough) %>% 
  batch_summarize(., coefs = list(
    '(Intercept)' = '$\\mu$', 
    'peak_Credit' = '$\\delta^{(P)}$', 
    'trough_Credit' = '$\\delta^{(T)}$'
  )) %>% slice(1,2,4,3) 

tbl_house <- 
  c(lmfit_house_peak, lmfit_house_trough) %>% 
  batch_summarize(., coefs = list(
    '(Intercept)' = '$\\mu$', 
    'peak_House' = '$\\delta^{(P)}$', 
    'trough_House' = '$\\delta^{(T)}$'
  )) %>% slice(1,2,4,3) 

tbl_leverage <- 
  c(lmfit_leverage_peak, lmfit_leverage_trough) %>% 
  batch_summarize(., coefs = list(
    '(Intercept)' = '$\\mu$', 
    'peak_Leverage' = '$\\delta^{(P)}$', 
    'trough_Leverage' = '$\\delta^{(T)}$'
  )) %>% slice(1,2,4,3) 

bind_rows(tbl_credit, tbl_house, tbl_leverage) %>% 
  kbl(booktabs = T, escape = F, align = 'c',
      caption = "Real GDP gaps after financial cycle peaks and troughs, with controls",
      col.names = c(" ", str_c("h=",0:6), str_c("h=",0:6))) %>% 
  pack_rows(index = c("Credit cycle"=4, "Real estate cycle"=4, "Leverage cycle"=4),
            hline_after = TRUE) %>%
  add_header_above(c(" ", "Quarters after peak"=7, "Quarters after trough"=7)) %>% 
  add_header_above(c(" ", "Dependent variable: 100 Ã— log GDP gap"=14)) %>% 
  footnote(general = paste0("Standard errors are heteroskedasticity and ",
                            "autocorrelation consistent. $p$-values are ", 
                            "reported in parentheses."), escape = F) %>% 
  kable_styling(full_width = T) %>% 
  landscape()
```


## Bayesian VAR

This section employs a VAR model to elicit the inter-relationship between the
variables of interest. The reduced-form of the model is as following

\begin{equation}
y_t = c + \sum_{j=1}^{p} \Phi_j y_{t-j} + u_t 
\label{eq:var-model}
\end{equation}

where 

\begin{equation}
y_t = [ 
  \text{GDP}_t, 
  \text{CPI}_t, 
  \text{IR}_t, 
  \text{Credit}_t, 
  \text{Credit/GDP}_t, 
  \text{House}_t 
  ] 
\label{eq:vars}
\end{equation}

All the variables included here are stationary (see Annex \ref{annex-unit-root}
for unit root test). Considering the limited size of the data, I estimate the
model with Bayesian method to avoid the "curse of dimensionality". I adopt the
Minnesota prior and set the prior AR(1) coefficient to zero. ^[Other parameters
of the Minnesota prior are left with standard settings: $\\lambda\_1=0.2$
(overall tightness), $\\lambda\_2=1$ (relative cross-variable weight),
$\\lambda\_3=1$ (lag decay).] To identify the structural shocks, Cholesky
decomposition is applied to the residuals with regard to the ordering of
variables as in Equation (\ref{eq:vars}). ^[This ordering is justified as
follows: the ordering of output, price level and interest rate follows directly
from standard IS/LM models, in which output responses to price level only with
lags, and central banks set interest rate in response to both output and price
level. It is reasonable to expect credit follows interest rate, not the other
way around. And credit fuels the purchasing of real estate. However, the results
are robust to different ordering the variables. Annex \ref{annex-ordering}
tests the sensitivity of the impulse responses to different ordering.]

The impulse responses of all variables are provided in Annex
\ref{annex-impulse}. I focus here on response of real variables to proxies of
financial cycles. Figure \ref{fig:imp-gdp} shows the (accumulated) impulse
response of GDP to innovations in credit, credit to GDP ratio, and housing
price. It shows that an unexpected increase in all three variables leads to
increase of real output, with housing price the most prominent. The up trend
peaks after roughly 10 quarters, then the trend starts to reverse. This suggests
a financial expansion presages an immediate bump up in real output, and then a
subsequent decline.

```{r imp-gdp, fig.cap="Impulse response of GDP to innovations", out.width="49%", fig.show="hold"}
knitr::include_graphics(c("graph/imp_gdp.pdf", "graph/imp_gdp_acc.pdf"))
```

Figure \ref{fig:imp-cpi} shows the response of price level, measured by CPI, to
an unexpected upward movement of financial cycle. Price level responds
positively to all three innovations, but price is much more sensitive to credit
shocks than output. The up-moving trend of the price level peaks in 9 quarters
after a positive credit shock. The rising house price has more enduring impact
on price level -- the upward movement lasts for 12 quarters before its reversal.

```{r imp-cpi, fig.cap="Impulse response of CPI to innovations", out.width="49%", fig.show="hold"}
knitr::include_graphics(c("graph/imp_cpi.pdf", "graph/imp_cpi_acc.pdf"))
```

Why the business cycle reverses its trend in two and a half years after a
financial expansion? The response of interest rate to financial cycle might shed
some light. As shown in Figure \ref{fig:imp-ir}, upward movement of credit or
housing price elicits rise in interest rate. The response of interest rate is
especially aggressive to rising housing price. The rising interest rate tightens
financial conditions and curbs real economic activities. This possibly explains
the reversal of the business cycle after a short-run expansion.

```{r imp-ir, fig.cap="Impulse response of interest rate to innovations", out.width="49%", fig.show="hold"}
knitr::include_graphics(c("graph/imp_ir.pdf", "graph/imp_ir_acc.pdf"))
```


Based on the orthogonalised shocks, one can calculate the contributions of each
shocks to the development of economic process. This may help understand the role
of financial factors in shaping business cycles. Figure \ref{fig:hd-gdp}
decomposes the historical cycles of GDP and CPI into different shocks. A full
list of historical decomposition can be found in Annex \ref{annex-hd-full}.

```{r hd-gdp, fig.cap="Historical decomposition", out.width="49%", fig.show="hold"}
knitr::include_graphics(c("graph/hd_gdp.pdf", "graph/hd_cpi.pdf"))
```

As shown in Figure \ref{fig:hd-gdp}, real GDP cycles are mostly contributed by
shocks to itself and shocks to CPI. Credit shocks played an important role
during before and during the GFC. The importance of credit gradually moderated
after the GFC. An exception is the year of 2012, in which credit shocks again
played a prominent role. This was a period when China's financial sector
undertook "innovations" to circumvent regulations.

House price historically played a prominent role in affecting the business
cycle. A notable feature is that house price tends to play a supportive role
when China's GDP swings below the growth trend. This can be explained by that
China's authority typically relax the policies that restrict home purchase to
counter economic downturn pressure. For example, during the economic downturn
in 2014, most cities remove the limits on the number of homes one can buy. The
importance of house price attenuated since 2016, as the authority adopted the
"long-term mechanism" for real estate regulation.


## Recession prediction

```{r, include=FALSE}
source("script/rec.R")
```

The last experiment is to test the predictive power of financial cycles for 
recessions. Financial indicators have been found to have strong predictive 
power for real economic outcomes in developed economies and are widely adopted 
in various economic leading indicators. 
This section is set to test the validity of various financial predictors 
in the context of China. 

There is no official classification of recessions in China.
In this study, I use the OECD based recession indicator.
^[Retrieved from Federal Reserve Bank of St. Louis, OECD based Recession Indicators
for China from the Period following the Peak through the Trough [CHNRECD];
https://fred.stlouisfed.org/series/CHNRECD. ]
The OECD CLI system is based on "growth cycle" approach, and a recession is 
defined as the period following the peak through the trough.
^[More details on OECD CLI system: OECD Composite Leading Indicators, 
"Composite Leading Indicators: Reference Turning Points and Component Series", 
http://www.oecd.org/std/leading-indicators/oecdcompositeleadingindicatorsreferenceturningpointsandcomponentseries.htm ]

The forecasting framework is as following:

\begin{equation}
\label{eq:rec-ols}
p_t = \alpha + \beta(L) \small\text{PREDICTOR}_t + \mathbf\Gamma(L) \mathbf X_t + e_t,
\end{equation}

\noindent 
where $p_t$ is the recession dummy, $\small\text{PREDICTOR}_t$ could be one of 
$\small\text{CREDIT}_t$, $\small\text{HOUSING}_t$, or $\small\text{LEVERAGE}_t$.
In order to incorporate past movements of cycles without including too many
lags, I use the past-two-year moving average (de-trended) values for all three 
predictors. $\mathbf X_t$ are the control variables. 

Due to the well-known problems with linear probability models -- the predicted 
values are not confined within 0 and 1, I also estimate a probit model:

\begin{equation}
\label{eq:rec-ols}
\text{probit} (p_t) = \alpha + \beta(L) \small\text{PREDICTOR}_t + \mathbf\Gamma(L) \mathbf X_t + e_t.
\end{equation}

To evaluate the predictive power of the model, I use the Receiver Operating 
Characteristic (ROC) curve, following @Schularick2012 and @jorda2021.
The ROC curve is a widely used tool to assess binary classification ability. 
The binary classifier here is $I(\hat p - \theta > 0)$, where $\hat p$ 
is the predicted value of the model, $\theta$ is a varying threshold. 
The ROC curve plots the true positive rate (TPR), defined as the number of 
true positives out of all classified positives, against the false positive 
rate (FPR), defined as the number of false positives out of all classified 
negatives. 
Both the TPR and FPR vary along with $\theta$. The larger the value of $\theta$,
the more conservative the classifier is in making recession calls
(positives). As a result, the classification of positives becomes more 
accurate; while at the same time, the classifier makes increasing number of
false positives (fall-out).
Conversely, the smaller the value of $\theta$, the more aggressive the 
classifier becomes. As the true positive rate declines, the false positive 
(fall-out) rate also decreases. 
Therefore, the 45-degree line is the benchmark non-informative line that
provides no predictive ability. Any informative classifier should be above 
the 45-degree line.
The area under the ROC curve (AUROC) provides a single statistic that gauges
the predictive power of the model. 

Figure \ref{fig:roc} plots the ROC curve of a linear probability model with 
a single regressor (credit, housing price, or leverage ratio).
All three models are above the 45-degree line, indicating they are all 
informative in predicting recessions. 
Among the three, credit has the best predictive power as a single predictor. 

```{r roc, fig.cap="Receiver Operating Characteristic Curve"}
plot_roc
```

Table \ref{tab:rec} compares the models with the three financial predictors
with a benchmark model with only GDP, CPI and Repo Rates as the predictors. 
The benchmark linear model has an AUROC of 0.853, which itself is good enough.
It is impressive that inclusion of any of the three financial variables 
increases the recession predictive power further more. 
The linear model with credit increases the AUROC to 0.953, which is almost 
close to perfect accuracy. 
The linear models with housing price and leverage ratios have AUROC of 
0.88 and 0.908 respectively. 
The probit models have slightly higher AUROC than their linear counterparts.

The magnitude of the coefficients are also sizable. 
Credit has a positive coefficient of 0.313.
Given the standard deviation of credit gaps is 0.747, if credit growth is 
one standard deviation above the trend for the past two years,
it increases the probability of subsequent recession by 0.233 points. 
Since the sample frequency of recessions is 0.476, credit alone predicts 
almost 50% of recessions. 

The leverage ratio also has a significant positive coefficient, though the 
magnitude is not as large as credit. 
These evidence are generally consistent with the experience from developed 
countries [@Schularick2012], though recessions are defined differently, that 
credit booms over past years is indicative of a higher risk of recessions 
(or crisis).

Another interesting finding is the negative coefficient of housing prices,
which can be interpreted as housing price booms alleviate the risk of 
recessions, or declining of housing price over the past years presage
subsequent recessions.
This seems suggest housing price is even more forward-looking than credit.

```{r rec}
table_rec %>% 
  kbl(booktabs = T, escape = F, 
      caption = "Recession prediction with financial cycles") %>% 
  add_header_above(c(" ", "OLS"=4, "Probit"=4)) %>% 
  add_header_above(c("", "Dependent variable: probability of recession"=8)) %>% 
  footnote(general = str_c(
    "Standard errors in parentheses. Marginal effects not reported.",
    "*$p<0.1$, **$p<0.05$, ***$p<0.01$."), escape = F) %>% 
  kable_styling(full_width = T) %>% 
  landscape()
```

# Discussion

The last section in the document will be used as the section title for the bibliography.


\cleardoublepage

# References {-}

<div id="refs"></div>

